---
title: "Entregable1"
author: "Norberto García Marín y María Soledad Pérez López"
date: "November 29, 2018"
output: pdf_document
---

# Índice


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

````{r,eval=FALSE}
##para que no se ejecuten el cacho de código

````

# Carga de la base de datos

```{r setup, include=FALSE}
#Carga de librerías necesarias
library(ggplot2)
library(lattice)
library(caret)

credit <-read.table("http://archive.ics.uci.edu/ml/machine-learning-databases/credit-screening/crx.data", sep = ",", na.strings = "?", header = F)
colnames(credit) <- c("Male","Age","Debt","Married","BankCustomer","EducationLevel","Ethnicity","YearsEmployed","PriorDefaul","Employed","CreditScore","DriversLicense","Citizen","ZipCode","Income","Approved")

# Informacion de los atributos. Columnas
# Male:	b, a. 
# Age:	continuous. 
# Debt:	continuous. 
# Married:	u, y, l, t. 
# BankCustomer:	g, p, gg. 
# EducationLevel:	c, d, cc, i, j, k, m, r, q, w, x, e, aa, ff. 
# Ethnicity:	v, h, bb, j, n, z, dd, ff, o. 
# YearsEmployed:	continuous. 
# PriorDefaul:	t, f. 
# Employed:	t, f. 
# CreditScore:	continuous. 
# DriversLicense:	t, f. 
# Citizen:	g, p, s. 
# ZipCode:	continuous. 
# Income:	continuous. 
# Approved: +,- (Si ha sido aprobado)



credit.trainIdx<-readRDS("credit.trainIdx.rds")
credit.Datos.Train<-credit[credit.trainIdx,]
credit.Datos.Test<-credit[-credit.trainIdx,]

nrow(credit.Datos.Train)
nrow(credit.Datos.Test)
```

# Preprocesar Datos
## Analizar las variables (análisis monovariable)


```{r setup, include=FALSE}

###########Funciones auxiliares##########################################################################
qqplot.data <- function (vec)                                                                           #
{                                                                                                       #
  y <- quantile(vec[!is.na(vec)], c(0.25, 0.75))                                                        #
  x <- qnorm(c(0.25, 0.75))                                                                             #
  slope <- diff(y)/diff(x)                                                                              #
  int <- y[1L] - slope * x[1L]                                                                          #
  d <- data.frame(resids = vec)                                                                         #
  ggplot(d, aes(sample = resids)) + stat_qq() + geom_abline(slope = slope,intercept = int)              #
}                                                                                                       #
#########################################################################################################


# Resumen de los todos los datos

summary(credit)

#######Analisis variable Male #######################
# Variable No Numérica                                                                                
# Resumen                                                                                             #
summary(credit[1], maxsum = Inf)                                                                      #   
# Numero de ocurrencias (porcentaje)                                              

porcent <- prop.table(table(credit$Male)) * 100

cbind(total=table(credit$Male), porcentaje=porcent) 

# Grafico de barras                                                                                   #
barplot(table(credit$Male))                                                                          
####################################
```


```{r setup, include=FALSE}
#######Analisis variable Age ######################################
# Variable Continua                                                                                   #
# Resumen                                                                                             #
summary(credit[2], maxsum = Inf)                                                                                                                                                               #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$Age)) * 100                                                         #
cbind(total=table(credit$Age), porcentaje=porcent)                                                                                                                                             #
# Histograma con frecuencias de aparicion


# Estimacion de la fucnión de desidad de probabilidad                                                 #
dens<-density(credit$Age,na.rm=T)                                                                      #
hist(credit$Age,xlab="",main="Age",ylim=c(0,max(dens$y)*1.1),probability =T)                            #
lines(dens)                                                                                           #
# rug() apra la repersentacion de lso valores reales del atributo, bajo el eje x                      #
# jitter() para añadir un poco de ruido aleatorio a los valores verdaderos,                           #
# por si hubiese valores repetidos                                                                    #
rug(jitter(credit$Age))                                                                                #
                                                                                                      #
                                                                                                      #
# Diagrama Box-Whisker. Informacion sobre la dispersion, asimetria estadistica                        #
# y posibles valores atipicos                                                                         #
boxplot(credit$Age,main="Age")                                                                          #
                                                                                                      #
                                                                                                      #
# Representacion de los percentiles con respecto a los de una normal centrada en cero                 #
qqplot.data(credit$Age)+ggtitle("Gráfica Q-Q para Age")                                                 #
                                                                                                      #
                                                                                                      #
#####################################
```

```{r}
#######Analisis variable Debt################################
# Variable Continua                                                                                   #
# Resumen                                                                                             #
summary(credit[3], maxsum = Inf)                                                                      #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$Debt)) * 100                                                         #
cbind(total=table(credit$Debt), porcentaje=porcent)                                                     #
                                                                                                      #
                                                                                                      #
# Histograma con frecuencias de aparicion                                                             #
# Estimacion de la fucnion de desidad de probabilidad                                                 #
dens<-density(credit$Debt,na.rm=T)                                                                      #
hist(credit$Debt,xlab="",main="Debt",ylim=c(0,max(dens$y)*1.1),probability =T)                            #
lines(dens)                                                                                           #
# rug() apra la repersentacion de lso valores reales del atributo, bajo el eje x                      #
# jitter() para añadir un poco de ruido aleatorio a los valores verdaderos,                           #
# por si hubiese valores repetidos                                                                    #
rug(jitter(credit$Debt))                                                                                #
                                                                                                      #
                                                                                                      #
# Diagrama Box-Whisker. Informacion sobre la dispersion, asimetria estadistica                        #
# y posibles valores atipicos                                                                         #
boxplot(credit$Debt,main="Debt")                                                                          #
                                                                                                      #
                                                                                                      #
# Representacion de los percentiles con respecto a los de una normal centrada en cero                 #
qqplot.data(credit$Debt)+ggtitle("Gráfica Q-Q para Debt")                                                 #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable Married############################################################################
# Variable No Numérica                                                                                   #
# Resumen                                                                                             #
summary(credit[4], maxsum = Inf)                                                                      #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$Married)) * 100                                                         #
cbind(total=table(credit$Married), porcentaje=porcent)                                                     #
                                                                                                      #
                                                                                                      #
# Grafico de barras                                                                                   #
barplot(table(credit$Married))                                                                             #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable BankCustomer############################################################################
# Variable No Numérica                                                                                   #
# Resumen                                                                                             #
summary(credit[5], maxsum = Inf)                                                                      #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$BankCustomer)) * 100                                                         #
cbind(total=table(credit$BankCustomer), porcentaje=porcent)                                                     #
                                                                                                      #
                                                                                                      #
# Grafico de barras                                                                                   #
barplot(table(credit$BankCustomer))                                                                             #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable EducationLevel############################################################################
# Variable No Numérica                                                                                   #
# Resumen                                                                                             #
summary(credit[6], maxsum = Inf)                                                                      #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$EducationLevel)) * 100                                                         #
cbind(total=table(credit$EducationLevel), porcentaje=porcent)                                                     #
                                                                                                      #
                                                                                                      #
# Grafico de barras                                                                                   #
barplot(table(credit$EducationLevel))                                                                             #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable Ethnicity############################################################################
# Variable No Numérica                                                                                   #
# Resumen                                                                                             #
summary(credit[7], maxsum = Inf)                                                                      #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$Ethnicity)) * 100                                                         #
cbind(total=table(credit$Ethnicity), porcentaje=porcent)                                                     #
                                                                                                      #
                                                                                                      #
# Grafico de barras                                                                                   #
barplot(table(credit$Ethnicity))                                                                             #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable YearsEmployed############################################################################
# Variable Continua                                                                                   #
# Resumen                                                                                             #
summary(credit[8], maxsum = Inf)                                                                      #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$YearsEmployed)) * 100                                                         #
cbind(total=table(credit$YearsEmployed), porcentaje=porcent)                                                     #
                                                                                                      #
                                                                                                      #
# Histograma con frecuencias de aparicion                                                             #
# Estimacion de la fucnion de desidad de probabilidad                                                 #
dens<-density(credit$YearsEmployed,na.rm=T)                                                                      #
hist(credit$YearsEmployed,xlab="",main="YearsEmployed",ylim=c(0,max(dens$y)*1.1),probability =T)                            #
lines(dens)                                                                                           #
# rug() apra la repersentacion de lso valores reales del atributo, bajo el eje x                      #
# jitter() para añadir un poco de ruido aleatorio a los valores verdaderos,                           #
# por si hubiese valores repetidos                                                                    #
rug(jitter(credit$YearsEmployed))                                                                                #
                                                                                                      #
                                                                                                      #
# Diagrama Box-Whisker. Informacion sobre la dispersion, asimetria estadistica                        #
# y posibles valores atipicos                                                                         #
boxplot(credit$YearsEmployed,main="YearsEmployed")                                                                          #
                                                                                                      #
                                                                                                      #
# Representacion de los percentiles con respecto a los de una normal centrada en cero                 #
qqplot.data(credit$YearsEmployed)+ggtitle("Gráfica Q-Q para YearsEmployed")                                                 #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable PriorDefaul############################################################################
# Variable No Numérica                                                                                   #
# Resumen                                                                                             #
summary(credit[9], maxsum = Inf)                                                                      #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$PriorDefaul)) * 100                                                         #
cbind(total=table(credit$PriorDefaul), porcentaje=porcent)                                                     #
                                                                                                      #
                                                                                                      #
# Grafico de barras                                                                                   #
barplot(table(credit$PriorDefaul))                                                                             #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable Employed###########################################################################
# Variable No Numérica                                                                                   #
# Resumen                                                                                             #
summary(credit[10], maxsum = Inf)                                                                     #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$Employed)) * 100                                                        #
cbind(total=table(credit$Employed), porcentaje=porcent)                                                    #
                                                                                                      #
                                                                                                      #
# Grafico de barras                                                                                   #
barplot(table(credit$Employed))                                                                            #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable CreditScore###########################################################################
# Variable Continua                                                                                   #
# Resumen                                                                                             #
summary(credit[11], maxsum = Inf)                                                                     #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$CreditScore)) * 100                                                        #
cbind(total=table(credit$CreditScore), porcentaje=porcent)                                                    #
                                                                                                      #
                                                                                                      #
# Histograma con frecuencias de aparicion                                                             #
# Estimacion de la fucnion de desidad de probabilidad                                                 #
dens<-density(credit$CreditScore,na.rm=T)                                                                     #
hist(credit$CreditScore,xlab="",main="CreditScore",ylim=c(0,max(dens$y)*1.1),probability =T)                          #
lines(dens)                                                                                           #
# rug() apra la repersentacion de lso valores reales del atributo, bajo el eje x                      #
# jitter() para añadir un poco de ruido aleatorio a los valores verdaderos,                           #
# por si hubiese valores repetidos                                                                    #
rug(jitter(credit$CreditScore))                                                                               #
                                                                                                      #
                                                                                                      #
# Diagrama Box-Whisker. Informacion sobre la dispersion, asimetria estadistica                        #
# y posibles valores atipicos                                                                         #
boxplot(credit$CreditScore,main="CreditScore")                                                                        #
                                                                                                      #
                                                                                                      #
# Representacion de los percentiles con respecto a los de una normal centrada en cero                 #
qqplot.data(credit$CreditScore)+ggtitle("Gráfica Q-Q para CreditScore")                                               #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable DriversLicense###########################################################################
# Variable No Numérica                                                                                   #
# Resumen                                                                                             #
summary(credit[12], maxsum = Inf)                                                                     #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$DriversLicense)) * 100                                                        #
cbind(total=table(credit$DriversLicense), porcentaje=porcent)                                                    #
                                                                                                      #
                                                                                                      #
# Grafico de barras                                                                                   #
barplot(table(credit$DriversLicense))                                                                            #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable Citizen###########################################################################
# Variable No Numérica                                                                                   #
# Resumen                                                                                             #
summary(credit[13], maxsum = Inf)                                                                     #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$Citizen)) * 100                                                        #
cbind(total=table(credit$Citizen), porcentaje=porcent)                                                    #
                                                                                                      #
                                                                                                      #
# Grafico de barras                                                                                   #
barplot(table(credit$Citizen))                                                                            #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable ZipCode###########################################################################
# Variable Continua                                                                                   #
# Resumen                                                                                             #
summary(credit[14], maxsum = Inf)                                                                     #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$ZipCode)) * 100                                                        #
cbind(total=table(credit$ZipCode), porcentaje=porcent)                                                    #
                                                                                                      #
                                                                                                      #
# Histograma con frecuencias de aparicion                                                             #
# Estimacion de la fucnion de desidad de probabilidad                                                 #
dens<-density(credit$ZipCode,na.rm=T)                                                                     #
hist(credit$ZipCode,xlab="",main="ZipCode",ylim=c(0,max(dens$y)*1.1),probability =T)                          #
lines(dens)                                                                                           #
# rug() apra la repersentacion de lso valores reales del atributo, bajo el eje x                      #
# jitter() para añadir un poco de ruido aleatorio a los valores verdaderos,                           #
# por si hubiese valores repetidos                                                                    #
rug(jitter(credit$ZipCode))                                                                               #
                                                                                                      #
                                                                                                      #
# Diagrama Box-Whisker. Informacion sobre la dispersion, asimetria estadistica                        #
# y posibles valores atipicos                                                                         #
boxplot(credit$ZipCode,main="ZipCode")                                                                        #
                                                                                                      #
                                                                                                      #
# Representacion de los percentiles con respecto a los de una normal centrada en cero                 #
qqplot.data(credit$ZipCode)+ggtitle("Gráfica Q-Q para ZipCode")                                               #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable Income##########################################################
# Variable Continua                                                                                   #
# Resumen                                                                                             #
summary(credit[15], maxsum = Inf)                                                                     #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$Income)) * 100                                                        #
cbind(total=table(credit$Income), porcentaje=porcent)                                                    #
                                                                                                      #
                                                                                                      #
# Histograma con frecuencias de aparicion                                                             #
# Estimacion de la fucnion de desidad de probabilidad                                                 #
dens<-density(credit$Income,na.rm=T)                                                                     #
hist(credit$Income,xlab="",main="Income",ylim=c(0,max(dens$y)*1.1),probability =T)                          #
lines(dens)                                                                                           #
# rug() apra la repersentacion de lso valores reales del atributo, bajo el eje x                      #
# jitter() para añadir un poco de ruido aleatorio a los valores verdaderos,                           #
# por si hubiese valores repetidos                                                                    #
rug(jitter(credit$Income))                                                                               #
                                                                                                      #
                                                                                                      #
# Diagrama Box-Whisker. Informacion sobre la dispersion, asimetria estadistica                        #
# y posibles valores atipicos                                                                         #
boxplot(credit$Income,main="Income")                                                                        #
                                                                                                      #
                                                                                                      #
# Representacion de los percentiles con respecto a los de una normal centrada en cero                 #
qqplot.data(credit$Income)+ggtitle("Gráfica Q-Q para Income")                                               #
                                                                                                      #
                                                                                                      #
#######################################################################################################
```


### Análisis multivariable

Para hacer las multivariables haremos uniones con la variable de clase [de salida ( +,-)], para ver como influyen. 

Calcularemos el coeficiente de correlación, matriz de correlación para poder comprender mejor lo que ocurre con el análisis 

```{r}
#pairs(credit[,2],col=as.numeric(credit$Approved))
#pairs(credit,credit$Approved)
#featurePlot(x=iris[,1:4],y=iris[,5],plot="ellipse")
featurePlot(x=credit[,2],y=credit[,16],plot="density")
###Variable Male table(credit$Male)


y = credit[16]
#Variable Age
featurePlot(x=credit[,2],y=credit[,16],plot="density")
##pairs(credit[,1],col=as.factor(credit$Approved))

#Variable Debt
featurePlot(x=credit[,3],y=credit[,16],plot="density")

```




## Tratar valores nulos/extremos/atípicos si los hubiese
### Tratamiento de valores nulos
Para tomar medida de cuán serio es el problema de los valores nulos, debemos contar los casos que tienen valores nulos
```{r}
# Tratamiento de valores nulos

# Elementos que queremos tratar
tibble::rowid_to_column(credit)[!complete.cases(credit),]

# Numero de filas con nulos
print("Numero de filas con valores nulos")
nrow(credit[!complete.cases(credit),])

# Porcentaje de valores nulos
print("Porcentaje de filas con valores nulos")
nrow(credit[!complete.cases(credit),])/nrow(credit)*100

```
Como vemos tenemos 37 filas con valores filas con valores nulos, lo  que supone un 5,362319% de casos.

No es recomendable deshacernos de los nulos sin más, ademas no hay ningun ejemplar que tenga muchas variables con valores nulos, por lo tanto la solucion seriá sustituirlas mediante valores representativos.


#### Sustitución mediante valores representativos
Como la muestra tiene una distribucion desplazada skewed para TODAS las variables continuas, la mediana es la mejor opcion como valor central para sustituir.

Para las variables no continuas sustituiremos los valores nulos por el valor que mas se repita


```{r}
# Tratamiento de las variables en funcion de si es continua o no continua
credit.fix<-credit
continua<-c(FALSE,TRUE,TRUE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,TRUE,FALSE,FALSE,TRUE,TRUE)

for(i in 1:15){
  if(continua[i]){
    nulos <- subset(credit.fix, is.na(credit.fix[,i]))
    credit.fix[as.numeric(rownames(nulos)), i] <-median(credit.fix[[i]],na.rm=T)
    
  } else {
    valorMasRepetido<-tail(names(sort(table(credit[i]))), 1)
    nulos <- subset(credit.fix, is.na(credit.fix[,i]))
    credit.fix[as.numeric(rownames(nulos)), i] <- valorMasRepetido
  }
}

```

Y comprobamos si se han sustituido correctamente
```{r}
print("Porcentaje de filas con valores nulos")
nrow(credit[!complete.cases(credit.fix),])/nrow(credit.fix)*100
```

### Tratamiento de valores extremos/atipicos
Sustitucion de los valores extremos y atipicos por la mediana de la variable en cuestion
```{r}
for(i in 1:15){
  if(!continua[i]) next;
  
  extremos<-boxplot(credit.fix[i],boxwex=0.15,plot=F)$out
  porArriba<-min(extremos[extremos > median(na.omit(credit.fix[[i]]))])
  porArribaSet <- credit.fix[credit.fix[i]>porArriba,]
  credit.fix[as.numeric(rownames(porArribaSet)), i] <- median(credit.fix[[i]],na.rm=T)
}
```


## Eliminar variables superfluas/añadir variables nuevas

### Eliminar variables con poca varianza
Vamos a intentar eliminar variables con poca varianza.
Cuando una variable tiene poca varianza indica que carece de mucha informacion para crear distinciones entre los datos. Esto puede generar problemas a muchos algoritmos de machine learning

Vemos si existe alguna variable con esta caracteristica
```{r}
nearZeroVar(credit.fix)
```

Vemos que no existe ninguna variable, por lo tanto dejamos el dataset como esta.

### Eliminar variables correladas

Cuando dos variables están muy correladas entre ellas basicamente representan la misma información. SUele ser interesante eliminar una de dichas variables y simplificar el modelo al tener menos variables de entrada.

Vemos si existen variables de este tipo:
```{r}
# Seleccionamos las variables de entrada
datos.input<-credit.fix[,1:15]
# Obtenemos la correlaci ́on solo de las variables num ́ericas de las variables de entrada
datos.cor<-cor(na.omit(datos.input[,sapply(datos.input,FUN=is.numeric)]))
# Obtenemos los nombres de las columnas num ́ericas de entrada correladas
colsToRemove<-labels(datos.cor)[[1]][findCorrelation(datos.cor,cutoff=0.85)]
# Eliminamos las columnas correladas del conjunto completo
credit.nocorr<-credit.fix[setdiff(names(credit.fix),colsToRemove)]
```

Comprobamos si el dataset de entrada y el de nocorr son diferentes

```{r}
identical(credit.nocorr,credit.fix)
```
No hay ninguna variable correlada por lo que no se puede eliminar nada.


#### Crear Dummy Variables
Las Variables Dummy es una forma de transformar factores en un conjunto de variables num ́ericas dondecada nivel es ortogonal al resto de variables dummy para ese factor.
as variables dummy son necesarias en algunos modelos matem ́aticos que trabajan con la matrizde atributos y valores de entrada.

Como caret transforma por defecto las variables de entrada que son factores creando dummy variables no haremos esta transformación de forma manual.


### Crear nuevas variables
```{r}
#Ejemplo de crear nuevas variables con Class Distribution
credit.fix.preProc.ClssDtrb.Mod<-classDist(credit.fix[,2:3],as.numeric(credit.fix[,16]))
# Añadimos las nuevas variables
credit.fix.xtra.Vars<-cbind(credit.fix,predict(credit.fix.preProc.ClssDtrb.Mod,credit.fix[,2:3]))
# Dibujamos las nuevas variables y las antiguas
p1<-featurePlot(x=predict(credit.fix.preProc.ClssDtrb.Mod,credit.fix[,1:15]),
                credit.fix[,16],plot="ellipse")
p2<-featurePlot(x=credit.fix[,1:15],credit.fix[,16],plot="ellipse")
print(p1,position=c(0,0,0.5,1),more=T)
print(p2,position=c(0.5,0,1,1))
```





## Transformar justificadamente los datos (normalizar/escalar/etc)

## Escalado





# Entrenar varios Modelos/Técnicas

## Escoger varios modelos/técnicas a comparar

## Encontrar los mejores hiper-parámetros (usar TunerGrid en, al menos, 1 modelo)

## Probar, al menos, un mismo modelo/técnica con 2 preprocesos de datos diferentes



# Comparar Modelos

## Comparar el rendimiento de los diferentes modelos

## Decidir justificadamente el modelo final

## Evaluar el rendimiento futuro del modelo final







