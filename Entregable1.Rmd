---
title: "Entregable1"
author: "Norberto García Marín y María Soledad Pérez López"
date: "November 29, 2018"
output: pdf_document
---

# Índice


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

````{r,eval=FALSE}
##para que no se ejecuten el cacho de código

````

# Carga de la base de datos

```{r setup, include=FALSE}
#Carga de librerías necesarias
library(ggplot2)
library(lattice)
library(caret)

credit <-read.table("http://archive.ics.uci.edu/ml/machine-learning-databases/credit-screening/crx.data", sep = ",", na.strings = "?", header = F)
colnames(credit) <- c("Male","Age","Debt","Married","BankCustomer","EducationLevel","Ethnicity","YearsEmployed","PriorDefaul","Employed","CreditScore","DriversLicense","Citizen","ZipCode","Income","Class")

# Informacion de los atributos. Columnas
# Male:	b, a. 
# Age:	continuous. 
# Debt:	continuous. 
# Married:	u, y, l, t. 
# BankCustomer:	g, p, gg. 
# EducationLevel:	c, d, cc, i, j, k, m, r, q, w, x, e, aa, ff. 
# Ethnicity:	v, h, bb, j, n, z, dd, ff, o. 
# YearsEmployed:	continuous. 
# PriorDefaul:	t, f. 
# Employed:	t, f. 
# CreditScore:	continuous. 
# DriversLicense:	t, f. 
# Citizen:	g, p, s. 
# ZipCode:	continuous. 
# Income:	continuous. 
# Class: +,- (class attribute)



credit.trainIdx<-readRDS("credit.trainIdx.rds")
credit.Datos.Train<-credit[credit.trainIdx,]
credit.Datos.Test<-credit[-credit.trainIdx,]

nrow(credit.Datos.Train)
nrow(credit.Datos.Test)
```

# Preprocesar Datos
## Analizar las variables (análisis monovariable)


```{r setup, include=FALSE}

###########Funciones auxiliares##########################################################################
qqplot.data <- function (vec)                                                                           #
{                                                                                                       #
  y <- quantile(vec[!is.na(vec)], c(0.25, 0.75))                                                        #
  x <- qnorm(c(0.25, 0.75))                                                                             #
  slope <- diff(y)/diff(x)                                                                              #
  int <- y[1L] - slope * x[1L]                                                                          #
  d <- data.frame(resids = vec)                                                                         #
  ggplot(d, aes(sample = resids)) + stat_qq() + geom_abline(slope = slope,intercept = int)              #
}                                                                                                       #
#########################################################################################################


# Resumen de los todos los datos

summary(credit)

#######Analisis variable Male############################################################################
# Variable No Numérica                                                                                
# Resumen                                                                                             #
summary(credit[1], maxsum = Inf)                                                                      #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$Male)) * 100                                                         #
cbind(total=table(credit$EducationLevel), porcentaje=porcent)                                                     #
                                                                                                      #
                                                                                                      #
# Grafico de barras                                                                                   #
barplot(table(credit$Male))                                                                             #
                                                                                                      #
                                                                                                      #
#######################################################################################################
```


```{r setup, include=FALSE}
#######Analisis variable Age############################################################################
# Variable Continua                                                                                   #
# Resumen                                                                                             #
summary(credit[2], maxsum = Inf)                                                                      #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$Age)) * 100                                                         #
cbind(total=table(credit$Age), porcentaje=porcent)                                                     #
                                                                                                      #
                                                                                                      #
# Histograma con frecuencias de aparicion                                                             #
# Estimacion de la fucnion de desidad de probabilidad                                                 #
dens<-density(credit$Age,na.rm=T)                                                                      #
hist(credit$Age,xlab="",main="Age",ylim=c(0,max(dens$y)*1.1),probability =T)                            #
lines(dens)                                                                                           #
# rug() apra la repersentacion de lso valores reales del atributo, bajo el eje x                      #
# jitter() para añadir un poco de ruido aleatorio a los valores verdaderos,                           #
# por si hubiese valores repetidos                                                                    #
rug(jitter(credit$Age))                                                                                #
                                                                                                      #
                                                                                                      #
# Diagrama Box-Whisker. Informacion sobre la dispersion, asimetria estadistica                        #
# y posibles valores atipicos                                                                         #
boxplot(credit$Age,main="Age")                                                                          #
                                                                                                      #
                                                                                                      #
# Representacion de los percentiles con respecto a los de una normal centrada en cero                 #
qqplot.data(credit$Age)+ggtitle("Gráfica Q-Q para Age")                                                 #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable Debt############################################################################
# Variable Continua                                                                                   #
# Resumen                                                                                             #
summary(credit[3], maxsum = Inf)                                                                      #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$Debt)) * 100                                                         #
cbind(total=table(credit$Debt), porcentaje=porcent)                                                     #
                                                                                                      #
                                                                                                      #
# Histograma con frecuencias de aparicion                                                             #
# Estimacion de la fucnion de desidad de probabilidad                                                 #
dens<-density(credit$Debt,na.rm=T)                                                                      #
hist(credit$Debt,xlab="",main="Debt",ylim=c(0,max(dens$y)*1.1),probability =T)                            #
lines(dens)                                                                                           #
# rug() apra la repersentacion de lso valores reales del atributo, bajo el eje x                      #
# jitter() para añadir un poco de ruido aleatorio a los valores verdaderos,                           #
# por si hubiese valores repetidos                                                                    #
rug(jitter(credit$Debt))                                                                                #
                                                                                                      #
                                                                                                      #
# Diagrama Box-Whisker. Informacion sobre la dispersion, asimetria estadistica                        #
# y posibles valores atipicos                                                                         #
boxplot(credit$Debt,main="Debt")                                                                          #
                                                                                                      #
                                                                                                      #
# Representacion de los percentiles con respecto a los de una normal centrada en cero                 #
qqplot.data(credit$Debt)+ggtitle("Gráfica Q-Q para Debt")                                                 #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable Married############################################################################
# Variable Discreta                                                                                   #
# Resumen                                                                                             #
summary(credit[4], maxsum = Inf)                                                                      #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$Married)) * 100                                                         #
cbind(total=table(credit$Married), porcentaje=porcent)                                                     #
                                                                                                      #
                                                                                                      #
# Grafico de barras                                                                                   #
barplot(table(credit$Married))                                                                             #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable BankCustomer############################################################################
# Variable Discreta                                                                                   #
# Resumen                                                                                             #
summary(credit[5], maxsum = Inf)                                                                      #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$BankCustomer)) * 100                                                         #
cbind(total=table(credit$BankCustomer), porcentaje=porcent)                                                     #
                                                                                                      #
                                                                                                      #
# Grafico de barras                                                                                   #
barplot(table(credit$BankCustomer))                                                                             #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable EducationLevel############################################################################
# Variable Discreta                                                                                   #
# Resumen                                                                                             #
summary(credit[6], maxsum = Inf)                                                                      #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$EducationLevel)) * 100                                                         #
cbind(total=table(credit$EducationLevel), porcentaje=porcent)                                                     #
                                                                                                      #
                                                                                                      #
# Grafico de barras                                                                                   #
barplot(table(credit$EducationLevel))                                                                             #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable Ethnicity############################################################################
# Variable Discreta                                                                                   #
# Resumen                                                                                             #
summary(credit[7], maxsum = Inf)                                                                      #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$Ethnicity)) * 100                                                         #
cbind(total=table(credit$Ethnicity), porcentaje=porcent)                                                     #
                                                                                                      #
                                                                                                      #
# Grafico de barras                                                                                   #
barplot(table(credit$Ethnicity))                                                                             #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable YearsEmployed############################################################################
# Variable Continua                                                                                   #
# Resumen                                                                                             #
summary(credit[8], maxsum = Inf)                                                                      #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$YearsEmployed)) * 100                                                         #
cbind(total=table(credit$YearsEmployed), porcentaje=porcent)                                                     #
                                                                                                      #
                                                                                                      #
# Histograma con frecuencias de aparicion                                                             #
# Estimacion de la fucnion de desidad de probabilidad                                                 #
dens<-density(credit$YearsEmployed,na.rm=T)                                                                      #
hist(credit$YearsEmployed,xlab="",main="YearsEmployed",ylim=c(0,max(dens$y)*1.1),probability =T)                            #
lines(dens)                                                                                           #
# rug() apra la repersentacion de lso valores reales del atributo, bajo el eje x                      #
# jitter() para añadir un poco de ruido aleatorio a los valores verdaderos,                           #
# por si hubiese valores repetidos                                                                    #
rug(jitter(credit$YearsEmployed))                                                                                #
                                                                                                      #
                                                                                                      #
# Diagrama Box-Whisker. Informacion sobre la dispersion, asimetria estadistica                        #
# y posibles valores atipicos                                                                         #
boxplot(credit$YearsEmployed,main="YearsEmployed")                                                                          #
                                                                                                      #
                                                                                                      #
# Representacion de los percentiles con respecto a los de una normal centrada en cero                 #
qqplot.data(credit$YearsEmployed)+ggtitle("Gráfica Q-Q para YearsEmployed")                                                 #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable PriorDefaul############################################################################
# Variable Discreta                                                                                   #
# Resumen                                                                                             #
summary(credit[9], maxsum = Inf)                                                                      #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$PriorDefaul)) * 100                                                         #
cbind(total=table(credit$PriorDefaul), porcentaje=porcent)                                                     #
                                                                                                      #
                                                                                                      #
# Grafico de barras                                                                                   #
barplot(table(credit$PriorDefaul))                                                                             #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable Employed###########################################################################
# Variable Discreta                                                                                   #
# Resumen                                                                                             #
summary(credit[10], maxsum = Inf)                                                                     #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$Employed)) * 100                                                        #
cbind(total=table(credit$Employed), porcentaje=porcent)                                                    #
                                                                                                      #
                                                                                                      #
# Grafico de barras                                                                                   #
barplot(table(credit$Employed))                                                                            #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable CreditScore###########################################################################
# Variable Continua                                                                                   #
# Resumen                                                                                             #
summary(credit[11], maxsum = Inf)                                                                     #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$CreditScore)) * 100                                                        #
cbind(total=table(credit$CreditScore), porcentaje=porcent)                                                    #
                                                                                                      #
                                                                                                      #
# Histograma con frecuencias de aparicion                                                             #
# Estimacion de la fucnion de desidad de probabilidad                                                 #
dens<-density(credit$CreditScore,na.rm=T)                                                                     #
hist(credit$CreditScore,xlab="",main="CreditScore",ylim=c(0,max(dens$y)*1.1),probability =T)                          #
lines(dens)                                                                                           #
# rug() apra la repersentacion de lso valores reales del atributo, bajo el eje x                      #
# jitter() para añadir un poco de ruido aleatorio a los valores verdaderos,                           #
# por si hubiese valores repetidos                                                                    #
rug(jitter(credit$CreditScore))                                                                               #
                                                                                                      #
                                                                                                      #
# Diagrama Box-Whisker. Informacion sobre la dispersion, asimetria estadistica                        #
# y posibles valores atipicos                                                                         #
boxplot(credit$CreditScore,main="CreditScore")                                                                        #
                                                                                                      #
                                                                                                      #
# Representacion de los percentiles con respecto a los de una normal centrada en cero                 #
qqplot.data(credit$CreditScore)+ggtitle("Gráfica Q-Q para CreditScore")                                               #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable DriversLicense###########################################################################
# Variable Discreta                                                                                   #
# Resumen                                                                                             #
summary(credit[12], maxsum = Inf)                                                                     #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$DriversLicense)) * 100                                                        #
cbind(total=table(credit$DriversLicense), porcentaje=porcent)                                                    #
                                                                                                      #
                                                                                                      #
# Grafico de barras                                                                                   #
barplot(table(credit$DriversLicense))                                                                            #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable Citizen###########################################################################
# Variable Discreta                                                                                   #
# Resumen                                                                                             #
summary(credit[13], maxsum = Inf)                                                                     #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$Citizen)) * 100                                                        #
cbind(total=table(credit$Citizen), porcentaje=porcent)                                                    #
                                                                                                      #
                                                                                                      #
# Grafico de barras                                                                                   #
barplot(table(credit$Citizen))                                                                            #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable ZipCode###########################################################################
# Variable Continua                                                                                   #
# Resumen                                                                                             #
summary(credit[14], maxsum = Inf)                                                                     #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$ZipCode)) * 100                                                        #
cbind(total=table(credit$ZipCode), porcentaje=porcent)                                                    #
                                                                                                      #
                                                                                                      #
# Histograma con frecuencias de aparicion                                                             #
# Estimacion de la fucnion de desidad de probabilidad                                                 #
dens<-density(credit$ZipCode,na.rm=T)                                                                     #
hist(credit$ZipCode,xlab="",main="ZipCode",ylim=c(0,max(dens$y)*1.1),probability =T)                          #
lines(dens)                                                                                           #
# rug() apra la repersentacion de lso valores reales del atributo, bajo el eje x                      #
# jitter() para añadir un poco de ruido aleatorio a los valores verdaderos,                           #
# por si hubiese valores repetidos                                                                    #
rug(jitter(credit$ZipCode))                                                                               #
                                                                                                      #
                                                                                                      #
# Diagrama Box-Whisker. Informacion sobre la dispersion, asimetria estadistica                        #
# y posibles valores atipicos                                                                         #
boxplot(credit$ZipCode,main="ZipCode")                                                                        #
                                                                                                      #
                                                                                                      #
# Representacion de los percentiles con respecto a los de una normal centrada en cero                 #
qqplot.data(credit$ZipCode)+ggtitle("Gráfica Q-Q para ZipCode")                                               #
                                                                                                      #
                                                                                                      #
#######################################################################################################


#######Analisis variable Income###########################################################################
# Variable Continua                                                                                   #
# Resumen                                                                                             #
summary(credit[15], maxsum = Inf)                                                                     #
                                                                                                      #
                                                                                                      #
# Numero de ocurrencias (porcentaje)                                                                  #
porcent <- prop.table(table(credit$Income)) * 100                                                        #
cbind(total=table(credit$Income), porcentaje=porcent)                                                    #
                                                                                                      #
                                                                                                      #
# Histograma con frecuencias de aparicion                                                             #
# Estimacion de la fucnion de desidad de probabilidad                                                 #
dens<-density(credit$Income,na.rm=T)                                                                     #
hist(credit$Income,xlab="",main="Income",ylim=c(0,max(dens$y)*1.1),probability =T)                          #
lines(dens)                                                                                           #
# rug() apra la repersentacion de lso valores reales del atributo, bajo el eje x                      #
# jitter() para añadir un poco de ruido aleatorio a los valores verdaderos,                           #
# por si hubiese valores repetidos                                                                    #
rug(jitter(credit$Income))                                                                               #
                                                                                                      #
                                                                                                      #
# Diagrama Box-Whisker. Informacion sobre la dispersion, asimetria estadistica                        #
# y posibles valores atipicos                                                                         #
boxplot(credit$Income,main="Income")                                                                        #
                                                                                                      #
                                                                                                      #
# Representacion de los percentiles con respecto a los de una normal centrada en cero                 #
qqplot.data(credit$Income)+ggtitle("Gráfica Q-Q para Income")                                               #
                                                                                                      #
                                                                                                      #
#######################################################################################################
```

## Analizar las variables (multivariable)
```{r}
```





## Análisis multivariable

Para hacer las multivariables haremos uniones con la variable de clase de salida ( +,-), para ver como influyen. 

```{r}
pairs(creadit[1:4],col=as.numeric(iris$clase))


```




## Tratar valores nulos/extremos/atípicos si los hubiese
### Tratamiento de valores nulos
Para tomar medida de cuán serio es el problema de los valores nulos, debemos contar los casos que tienen valores nulos
```{r}
# Tratamiento de valores nulos

# Elementos que queremos tratar
tibble::rowid_to_column(credit)[!complete.cases(credit),]

# Numero de filas con nulos
print("Numero de filas con valores nulos")
nrow(credit[!complete.cases(credit),])

# Porcentaje de valores nulos
print("Porcentaje de filas con valores nulos")
nrow(credit[!complete.cases(credit),])/nrow(credit)*100

```
Como vemos tenemos 37 filas con valores filas con valores nulos, lo  que supone un 5,362319% de casos.

No es recomendable deshacernos de los nulos sin más, ademas no hay ningun ejemplar que tenga muchas variables con valores nulos, por lo tanto la solucion seriá sustituirlas mediante valores representativos.


#### Sustitución mediante valores representativos
Como la muestra tiene una distribucion desplazada skewed para TODAS las variables continuas, la mediana es la mejor opcion como valor central para sustituir.

Para las variables no continuas sustituiremos los valores nulos por el valor que mas se repita


```{r}
# Tratamiento de las variables en funcion de si es continua o no continua
credit.fix<-credit
continua<-c(FALSE,TRUE,TRUE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,TRUE,FALSE,FALSE,TRUE,TRUE)

for(i in 1:15){
  if(continua[i]){
    nulos <- subset(credit.fix, is.na(credit.fix[,i]))
    credit.fix[as.numeric(rownames(nulos)), i] <-median(credit.fix[[i]],na.rm=T)
    
  } else {
    valorMasRepetido<-tail(names(sort(table(credit[i]))), 1)
    nulos <- subset(credit.fix, is.na(credit.fix[,i]))
    credit.fix[as.numeric(rownames(nulos)), i] <- valorMasRepetido
  }
}

```

Y comprobamos si se han sustituido correctamente
```{r}
print("Porcentaje de filas con valores nulos")
nrow(credit[!complete.cases(credit.fix),])/nrow(credit.fix)*100
```

### Tratamiento de valores extremos/atipicos
Sustitucion de los valores extremos y atipicos por la mediana de la variable en cuestion
```{r}
for(i in 1:15){
  if(!continua[i]) next;
  
  extremos<-boxplot(credit.fix[i],boxwex=0.15,plot=F)$out
  porArriba<-min(extremos[extremos > median(na.omit(credit.fix[[i]]))])
  porArribaSet <- credit.fix[credit.fix[i]>porArriba,]
  credit.fix[as.numeric(rownames(porArribaSet)), i] <- median(credit.fix[[i]],na.rm=T)
}
```



## Eliminar variables superfluas/añadir variables nuevas



## Transformar justificadamente los datos (normalizar/escalar/etc)




# Entrenar varios Modelos/Técnicas

## Escoger varios modelos/técnicas a comparar

## Encontrar los mejores hiper-parámetros (usar TunerGrid en, al menos, 1 modelo)

## Probar, al menos, un mismo modelo/técnica con 2 preprocesos de datos diferentes



# Comparar Modelos

## Comparar el rendimiento de los diferentes modelos

## Decidir justificadamente el modelo final

## Evaluar el rendimiento futuro del modelo final







